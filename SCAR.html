<div class="grid grid-2">
    <div id="char_info_1" class="section">
        <table>
            <tr>
                <th class="crimson" scope="row">Name:</th>
                <td class="white">
                    <input type="text" name="attr_character_name"/>
                </td>
            </tr>
            <tr>
                <th class="crimson" scope="row">Player:</th>
                <td class="white">
                    <input type="text" name="attr_player"/>
                </td>
            </tr>
            <tr>
                <th class="crimson" scope="row">World:</th>
                <td class="white">
                    <input type="text" name="attr_world"/>
                </td>
            </tr>
            <tr>
                <th class="crimson" scope="row">Species:</th>
                <td class="white">
                    <input type="text" name="attr_species"/>
                </td>
            </tr>
        </table>
    </div>
    <div id="char_info_2" class="section">
        <table>
            <tr>
                <th class="crimson" scope="row">Gender:</th>
                <td class="white">
                    <input type="text" name="attr_gender"/>
                </td>
            </tr>
            <tr>
                <th class="crimson" scope="row">Age:</th>
                <td class="white">
                    <input type="number" name="attr_age" min="1"/>
                </td>
            </tr>
            <tr>
                <th class="crimson" scope="row">Weight:</th>
                <td class="white">
                    <input type="text" name="attr_weight"/>
                </td>
            </tr>
            <tr>
                <th class="crimson" scope="row">Height:</th>
                <td class="white">
                    <input type="text" name="attr_height"/>
                </td>
            </tr>
        </table>
    </div>
</div>

<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="basic" />
<div>
    <button type="action" name="act_tab_basic" class="sheet-button0">Basic</button>
    <button type="action" name="act_tab_combat" class="sheet-button1">Combat</button>
    <button type="action" name="act_tab_attacks" class="sheet-button2">Attacks</button>
    <button type="action" name="act_tab_feats" class="sheet-button3">Feats</button>
    <button type="action" name="act_tab_exp" class="sheet-button4">EXP/Merits</button>
    <button type="action" name="act_tab_inventory" class="sheet-button5">Inventory</button>

    <button type="action" name="act_character_init" class="danger-button">Init Character</button>
</div>

<div class="basic">
    <div class="grid grid-2">
        <div id="stats" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="6">Quick Reference Stats</th>
                </tr>
                <tr>
                    <th class="gray">Current HP</th>
                    <th class="gray">Max HP</th>
                    <th class="gray">Temp HP</th>
                    <th class="gray">Extra Max HP</th>
                    <th class="gray">Current Exhaustion</th>
                    <th class="gray">Exhaustion Penalty</th>
                </tr>
                <tr class="white large">
                    <td><input type="number" name="attr_hp" value="0"/></td>
                    <td>
                        <input type="hidden" name="attr_hp_max" value="0"/>
                        <span name="attr_hp_max"></span>
                    </td>
                    <td><input type="number" name="attr_temp_hp" value="0"/></td>
                    <td><input type="number" name="attr_extra_max_hp" value="0"/></td>
                    <td><input type="number" name="attr_current_exhaustion" value="0"/></td>
                    <td><input type="number" name="attr_exhaustion_penalty" value="0"/></td>
                </tr>
                <tr>
                    <th class="gray">Physical Evasion</th>
                    <th class="gray">Physical Integrity</th>
                    <th class="gray">Special Evasion</th>
                    <th class="gray">Special Integrity</th>
                    <th class="gray">Soul Save</th>
                    <th class="gray">Boosts Per Session</th>
                </tr>
                <tr>
                    <td>
                        <input type="hidden" name="attr_physical_evasion">
                        <span name="attr_physical_evasion"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_physical_integrity">
                        <span name="attr_physical_integrity"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_special_evasion">
                        <span name="attr_special_evasion"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_special_integrity">
                        <span name="attr_special_integrity"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_soul_save">
                        <span name="attr_soul_save"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_boost_per_session">
                        <span name="attr_boost_per_session"></span>
                    </td>
                </tr>
            </table>
        </div>
        <div id="movement" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="6">Movement</th>
                </tr>
                <tr>
                    <th class="gray" scope="col">Land</th>
                    <th class="gray" scope="col">Burrow</th>
                    <th class="gray" scope="col">Climb</th>
                    <th class="gray" scope="col">Fly</th>
                    <th class="gray" scope="col">Hover</th>
                    <th class="gray" scope="col">Swim</th>
                </tr>
                <tr>
                    <td class="white"><input type="number" name="attr_movement_land" value="30"/></td>
                    <td class="white"><input type="number" name="attr_movement_burrow" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_climb" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_fly" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_hover" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_swim" value="0"/></td>
                </tr>
            </table>
        </div>
    </div>
    <button type="action" name="act_skill_check">Make Skill Check</button>
    <button type="action" name="act_dot_roll">Do Dot Roll</button>
    <div class="grid grid-3">
        <div id="attributes" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="3" scope="colgroup">Attributes</th>
                    <th class="gray large" scope="col">B</th>
                </tr>
                <tr>
                    <th class="gray" colspan="4" scope="colgroup">Primary Attributes</th>
                </tr>
                <tr class="small">
                    <th class="gray" scope="row">Body</th>
                    <td id="body_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_body" min="1" max="10" value="1"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_body_bonus" value="0"/>
                    </td>
                </tr>
                <tr class="small">
                    <th class="gray" scope="row">Mind</th>
                    <td id="mind_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_mind" min="1" max="10" value="1"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_mind_bonus" value="0"/>
                    </td>
                </tr>
                <tr class="small">
                    <th class="gray" scope="row">Soul</th>
                    <td id="soul_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_soul" min="1" max="10" value="1"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_soul_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" colspan="4" scope="colgroup">Secondary Attributes</th>
                </tr>
                <tr class="small">
                    <th class="gray" scope="row">Vigor</th>
                    <td id="vigor_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_vigor" min="1" max="10" value="1"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_vigor_bonus" value="0"/>
                    </td>
                </tr>
                <tr class="small">
                    <th class="gray" scope="row">Willpower</th>
                    <td id="willpower_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_willpower" min="1" max="10" value="1"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_willpower_bonus" value="0"/>
                    </td>
                </tr>
            </table>
        </div>
        <div id="expertise" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="3" scope="colgroup">Expertise</th>
                    <th class="gray large" scope="col">B</th>
                </tr>
                <tr>
                    <th class="gray" scope="row">Charming</th>
                    <td id="charming_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_charming" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_charming_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Cunning</th>
                    <td id="cunning_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_cunning" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_cunning_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Empathetic</th>
                    <td id="empathetic_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_empathetic" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_empathetic_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Forceful</th>
                    <td id="forceful_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_forceful" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_forceful_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Innovative</th>
                    <td id="innovative_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_innovative" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_innovative_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Instinct</th>
                    <td id="instinct_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_instinct" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_instinct_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Logic</th>
                    <td id="logic_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_logic" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_logic_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Teamwork</th>
                    <td id="teamwork_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_teamwork" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_teamwork_bonus" value="0"/>
                    </td>
                </tr>
            </table>
        </div>
        <div id="natural_skills" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="3" scope="colgroup">Natural Skills</th>
                    <th class="gray large" scope="col">B</th>
                </tr>
                <tr>
                    <th class="gray" scope="row">Athletics</th>
                    <td id="athletics_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_athletics" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_athletics_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Brawl</th>
                    <td id="brawl_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_brawl" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_brawl_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">
                        Initiative
                        <button type="roll" name="roll_init" value="/roll (@{initiative} + @{initiative_bonus} + 1)d10 &{tracker}"></button>
                    </th>
                    <td id="initiative_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_initiative" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_initiative_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Insight</th>
                    <td id="insight_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_insight" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_insight_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Integrity</th>
                    <td id="integrity_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_integrity" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_integrity_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Perception</th>
                    <td id="perception_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_perception" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_perception_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Persuasion</th>
                    <td id="persuasion_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_persuasion" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_persuasion_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Presence</th>
                    <td id="presence_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_presence" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_presence_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Send</th>
                    <td id="send_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_send" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_send_bonus" value="0"/>
                    </td>
                </tr>
            </table>
        </div>
        <div id="trained_skills" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="3" scope="colgroup">Trained Skills</th>
                    <th class="gray large" scope="col">B</th>
                </tr>
                <tr>
                    <th class="gray" scope="row">Acrobatics</th>
                    <td id="acrobatics_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_acrobatics" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_acrobatics_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Clash</th>
                    <td id="clash_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_clash" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_clash_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Deception</th>
                    <td id="deception_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_deception" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_deception_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Evasion</th>
                    <td id="evasion_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_evasion" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_evasion_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Marksman</th>
                    <td id="marksman_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_marksman" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_marksman_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Navigation</th>
                    <td id="navigation_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_navigation" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_navigation_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Perform</th>
                    <td id="perform_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_perform" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_perform_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Subterfuge</th>
                    <td id="subterfuge_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_subterfuge" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_subterfuge_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Survival</th>
                    <td id="survival_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_survival" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_survival_bonus" value="0"/>
                    </td>
                </tr>
            </table>
        </div>
        <div id="knowledge_skills" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="3" scope="colgroup">Knowledge Skills</th>
                    <th class="gray large" scope="col">B</th>
                </tr>
                <tr>
                    <th class="gray" scope="row">Academics</th>
                    <td id="academics_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_academics" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_academics_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Appraisal</th>
                    <td id="appraisal_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_appraisal" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_appraisal_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Craft</th>
                    <td id="craft_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_craft" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_craft_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Etiquette</th>
                    <td id="etiquette_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_etiquette" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_etiquette_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Investigation</th>
                    <td id="investigation_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_investigation" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_investigation_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Lore</th>
                    <td id="lore_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_lore" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_lore_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Medicine</th>
                    <td id="medicine_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_medicine" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_medicine_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Science</th>
                    <td id="science_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_science" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_science_bonus" value="0"/>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Technology</th>
                    <td id="technology_dots" class="white"></td>
                    <td class="white">
                        <input type="number" name="attr_technology" min="0" value="0" max="5"/>
                    </td>
                    <td class="gray">
                        <input type="number" name="attr_technology_bonus" value="0"/>
                    </td>
                </tr>
            </table>
        </div>
        <div id="custom_skills" class="section">
            <fieldset class="repeating_customskills">
                <input type="text" name="attr_custom_name"/>
                <input type="number" name="attr_custom_value" min="0" value="0" max="5"/>
                <input type="number" name="attr_custom_value_bonus" value="0"/>
            </fieldset>
        </div>
    </div>
</div>
<div class="combat">
    <div class="grid grid-2">
        <div id="stats2" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="6">Quick Reference Stats</th>
                </tr>
                <tr>
                    <th class="gray">Current HP</th>
                    <th class="gray">Max HP</th>
                    <th class="gray">Temp HP</th>
                    <th class="gray">Extra Max HP</th>
                    <th class="gray">Current Exhaustion</th>
                    <th class="gray">Exhaustion Penalty</th>
                </tr>
                <tr class="white large">
                    <td><input type="number" name="attr_hp" value="0"/></td>
                    <td>
                        <input type="hidden" name="attr_hp_max" value="0"/>
                        <span name="attr_hp_max"></span>
                    </td>
                    <td><input type="number" name="attr_temp_hp" value="0"/></td>
                    <td><input type="number" name="attr_extra_max_hp" value="0"/></td>
                    <td><input type="number" name="attr_current_exhaustion" value="0"/></td>
                    <td><input type="number" name="attr_exhaustion_penalty" value="0"/></td>
                </tr>
                <tr>
                    <th class="gray">Physical Evasion</th>
                    <th class="gray">Physical Integrity</th>
                    <th class="gray">Special Evasion</th>
                    <th class="gray">Special Integrity</th>
                    <th class="gray">Soul Save</th>
                    <th class="gray">Boosts Per Session</th>
                </tr>
                <tr>
                    <td>
                        <input type="hidden" name="attr_physical_evasion">
                        <span name="attr_physical_evasion"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_physical_integrity">
                        <span name="attr_physical_integrity"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_special_evasion">
                        <span name="attr_special_evasion"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_special_integrity">
                        <span name="attr_special_integrity"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_soul_save">
                        <span name="attr_soul_save"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_boost_per_session">
                        <span name="attr_boost_per_session"></span>
                    </td>
                </tr>
            </table>
        </div>
        <div id="movement" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="6">Movement</th>
                </tr>
                <tr>
                    <th class="gray" scope="col">Land</th>
                    <th class="gray" scope="col">Burrow</th>
                    <th class="gray" scope="col">Climb</th>
                    <th class="gray" scope="col">Fly</th>
                    <th class="gray" scope="col">Hover</th>
                    <th class="gray" scope="col">Swim</th>
                </tr>
                <tr>
                    <td class="white"><input type="number" name="attr_movement_land" value="30"/></td>
                    <td class="white"><input type="number" name="attr_movement_burrow" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_climb" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_fly" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_hover" value="0"/></td>
                    <td class="white"><input type="number" name="attr_movement_swim" value="0"/></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="grid grid-3">
        <button type="action" name="act_accuracy_move_roll">Roll Move Accuracy</button>
        <button type="action" name="act_accuracy_effect_roll">Roll Effect Accuracy</button>
        <button type="action" name="act_power_roll">Roll Power</button>
    </div>
    <div class="grid grid-2">
        <div id="passive-stat-changes" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="4">Passive Stat Changes</th>
                </tr>
                <tr>
                    <th class="gray">Phys. Damage</th>
                    <td><input type="number" name="attr_passive_phys_damage_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Crit Chance</th>
                    <td><input type="number" name="attr_passive_crit_chance_stage" value="0" min="-3" max="3"/></td>
                </tr>
                <tr>
                    <th class="gray">Spec. Damage</th>
                    <td><input type="number" name="attr_passive_spec_damage_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Accuracy</th>
                    <td><input type="number" name="attr_passive_accuracy_stage" value="0" min="-6" max="6"/></td>
                </tr>
                <tr>
                    <th class="gray">Phys. Integrity</th>
                    <td><input type="number" name="attr_passive_phys_integrity_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Evasion</th>
                    <td><input type="number" name="attr_passive_evasion_stage" value="0" min="-6" max="6"/></td>
                </tr>
                <tr>
                    <th class="gray">Spec. Integrity</th>
                    <td><input type="number" name="attr_passive_spec_integrity_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Initiative</th>
                    <td><input type="number" name="attr_passive_initiative_stage" value="0" min="-6" max="6"/></td>
                </tr>
                <tr>
                    <th class="gray">Soul Save</th>
                    <td><input type="number" name="attr_passive_soul_save_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Speed</th>
                    <td><input type="number" name="attr_passive_speed_stage" value="0" min="-6" max="6"/></td>
                </tr>
            </table>
        </div>
        <div id="active-stat-changes" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="4">Active Stat Changes <button type="action" name="act_reset_stat_changes">Reset</button></th>
                </tr>
                <tr>
                    <th class="gray">Phys. Damage</th>
                    <td><input type="number" name="attr_phys_damage_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Crit Chance</th>
                    <td><input type="number" name="attr_crit_chance_stage" value="0" min="-3" max="3"/></td>
                </tr>
                <tr>
                    <th class="gray">Spec. Damage</th>
                    <td><input type="number" name="attr_spec_damage_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Accuracy</th>
                    <td><input type="number" name="attr_accuracy_stage" value="0" min="-6" max="6"/></td>
                </tr>
                <tr>
                    <th class="gray">Phys. Integrity</th>
                    <td><input type="number" name="attr_phys_integrity_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Evasion</th>
                    <td><input type="number" name="attr_evasion_stage" value="0" min="-6" max="6"/></td>
                </tr>
                <tr>
                    <th class="gray">Spec. Integrity</th>
                    <td><input type="number" name="attr_spec_integrity_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Initiative</th>
                    <td><input type="number" name="attr_initiative_stage" value="0" min="-6" max="6"/></td>
                </tr>
                <tr>
                    <th class="gray">Soul Save</th>
                    <td><input type="number" name="attr_soul_save_stage" value="0" min="-6" max="6"/></td>
                    <th class="gray">Speed</th>
                    <td><input type="number" name="attr_speed_stage" value="0" min="-6" max="6"/></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<div class="attacks">
    <div class="grid grid-2">
        <div id="combat_skills" class="section">
            <table>
                <tr>
                    <th class="crimson large" colspan="2" scope="colgroup">Combat Skills</th>
                    <th class="gray large" scope="col">B</th>
                </tr>
                <tr>
                    <th class="gray" scope="row">Brawl (Melee Move)</th>
                    <td class="white">
                        <span name="attr_brawl"></span>
                    </td>
                    <td class="gray">
                        <span name="attr_brawl_bonus"></span>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Clash (Melee Weapon)</th>
                    <td class="white">
                        <span name="attr_clash"></span>
                    </td>
                    <td class="gray">
                        <span name="attr_clash_bonus"></span>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Marksman (Ranged Weapon)</th>
                    <td class="white">
                        <span name="attr_marksman"></span>
                    </td>
                    <td class="gray">
                        <span name="attr_marksman_bonus"></span>
                    </td>
                </tr>
                <tr>
                    <th class="gray" scope="row">Send (Ranged Move)</th>
                    <td class="white">
                        <span name="attr_send"></span>
                    </td>
                    <td class="gray">
                        <span name="attr_send_bonus"></span>
                    </td>
                </tr>
            </table>
        </div>
        <div id="exp_caps" class="section">
            <table>
                <tr>
                    <th colspan="6" class="crimson">EXP Caps</th>
                </tr>
                <tr>
                    <th colspan="2" class="gray">Quick Action</th>
                    <th colspan="2" class="gray">Standard Action</th>
                    <th colspan="2" class="gray">Full Action</th>
                </tr>
                <tr>
                    <th class="gray">EXP</th>
                    <th class="gray">Power</th>
                    <th class="gray">EXP</th>
                    <th class="gray">Power</th>
                    <th class="gray">EXP</th>
                    <th class="gray">Power</th>
                </tr>
                <tr>
                    <td><input type="hidden" name="attr_cap_qa_exp"/><span name="attr_cap_qa_exp"></span></td>
                    <td><input type="hidden" name="attr_cap_qa_power"/><span name="attr_cap_qa_power"></span></td>
                    <td><input type="hidden" name="attr_cap_sa_exp"/><span name="attr_cap_sa_exp"></span></td>
                    <td><input type="hidden" name="attr_cap_sa_power"/><span name="attr_cap_sa_power"></span></td>
                    <td><input type="hidden" name="attr_cap_fa_exp"/><span name="attr_cap_fa_exp"></span></td>
                    <td><input type="hidden" name="attr_cap_fa_power"/><span name="attr_cap_fa_power"></span></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="grid grid-3">
        <button type="action" name="act_accuracy_move_roll">Roll Move Accuracy</button>
        <button type="action" name="act_accuracy_effect_roll">Roll Effect Accuracy</button>
        <button type="action" name="act_power_roll">Roll Power</button>
    </div>
    <fieldset class="repeating_attacklist">
        <div class="repeating-table item-table">
            <!--Row 1-->
            <div class="crimson">Name</div>
            <div class="repeating-colspan-5"><input type="text" name="attr_attack_name"></div>
            <div class="crimson">Extra Effects</div>
            <!--Row 2-->
            <div class="crimson">Type</div>
            <div class="repeating-colspan-5">
                 <select name="attr_attack_type">
                    <option value="physical">Physical</option>
                    <option value="special">Special</option>
                 </select>
            </div>
            <div class="repeating-rowspan-7"><textarea name="attr_attack_freetext"></textarea></div>
            <!--Row 3-->
            <div class="crimson">Skill</div>
            <div class="repeating-colspan-5"><input type="text" name="attr_attack_skill"></div>
            <!--Row 4-->
            <div class="crimson">Element</div>
            <div class="repeating-colspan-5"><input type="text" name="attr_attack_element"></div>
            <!--Row 5-->
            <div class="crimson">Accuracy</div>
            <div><input type="number" name="attr_attack_accuracy"/></div>
            <div class="crimson">Power</div>
            <div><input type="number" name="attr_attack_power"/></div>
            <div class="crimson">Range</div>
            <div><input class="small-textbox" type="text" name="attr_attack_range"/></div>
            <!--Row 6-->
            <div class="crimson">EXP</div>
            <div class="repeating-colspan-2">
                <div>
                    <input type="number" name="attr_attack_exp"/>
                    /
                    <input type="number" name="attr_attack_exp_max"/>
                </div>
            </div>
            <div class="crimson">Action</div>
            <div class="repeating-colspan-2">
                <select class="middle-textbox" name="attr_attack_action">
                    <option value="STD">Standard</option>
                    <option value="QCK">Quick</option>
                    <option value="FUL">Full</option>
                </select>
            </div>
            <!--Row 7-->
            <div class="repeating-colspan-3">
                <button type="action" name="act_specificaccuracymoveroll">Roll Accuracy</button>
            </div>
            <div class="repeating-colspan-3">
                <button type="action" name="act_specificpowermoveroll">Roll Power</button>
            </div>
        </div>
    </fieldset>
</div>
<div class="feats repeating-row-table grid-like-padding">
    <div class="header">
        <!--Row 1-->
        <div class="crimson repeating-colspan-2 large">Feats</div>
        <!-- Row 2-->
        <div class="gray">Name</div>
        <div class="gray">Effect</div>
    </div>
    <fieldset class="repeating_feats">
        <div><input type="text" name="attr_feat_name"/></div>
        <div><textarea class="small-textarea" name="attr_feat_description" rows="2"></textarea></div>
    </fieldset>
</div>
<div class="exp">
    <div class="grid grid-2">
        <div id="exp">
            <table>
                <tr>
                    <th class="crimson large" colspan="4">EXP Information</th>
                </tr>
                <tr>
                    <th class="gray">Spent</th>
                    <th class="gray">Earned</th>
                    <th class="gray">Discount</th>
                    <th class="gray">Effective</th>
                </tr>
                <tr>
                    <td>
                        <input type="hidden" name="attr_exp_total_spent" value="0"/>
                        <span name="attr_exp_total_spent"></span>
                    </td>
                    <td>
                        <input type="number" name="attr_exp_total_earned" value="0"/>
                    </td>
                    <td>
                        <input type="hidden" name="attr_exp_total_discount" value="0"/>
                        <span name="attr_exp_total_discount"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_exp_grand_total" value="0"/>
                        <span name="attr_exp_grand_total"></span>
                    </td>
                </tr>
            </table>
            <div class="exp-purchases repeating-row-table">
                <div class="header">
                    <!--Row 1-->
                    <div class="crimson large repeating-colspan-4">EXP Purchases</div>
                    <!--Row 2-->
                    <div class="gray">Purchase Info</div>
                    <div class="gray">Initial</div>
                    <div class="gray">Discount</div>
                    <div class="gray">Final</div>
                </div>
                <fieldset class="repeating_exppurchases">
                    <div><input type="text" name="attr_exp_purchase_info"/></div>
                    <div><input type="number" name="attr_exp_initial" value="0" min="0"/></div>
                    <div><input type="number" name="attr_exp_discount" value="0" min="0"/></div>
                    <div>
                        <input type="hidden" name="attr_exp_total" value="0"/>
                        <span name="attr_exp_total"></span>
                    </div>
                </fieldset>
            </div>
        </div>
        <div id="merits">
            <table>
                <tr>
                    <th class="crimson large" colspan="4">Merit Information</th>
                </tr>
                <tr>
                    <th class="gray">Spent</th>
                    <th class="gray">Earned</th>
                    <th class="gray">Discount</th>
                    <th class="gray">Effective</th>
                </tr>
                <tr>
                    <td>
                        <input type="hidden" name="attr_merit_total_spent" value="0"/>
                        <span name="attr_merit_total_spent"></span>
                    </td>
                    <td>
                        <input type="number" name="attr_merit_total_earned" value="0"/>
                    </td>
                    <td>
                        <input type="hidden" name="attr_merit_total_discount" value="0"/>
                        <span name="attr_merit_total_discount"></span>
                    </td>
                    <td>
                        <input type="hidden" name="attr_merit_grand_total" value="0"/>
                        <span name="attr_merit_grand_total"></span>
                    </td>
                </tr>
            </table>
            <div class="exp-purchases repeating-row-table">
                <div class="header">
                    <!--Row 1-->
                    <div class="crimson large repeating-colspan-4">Merit Purchases</div>
                    <!--Row 2-->
                    <div class="gray">Purchase Info</div>
                    <div class="gray">Initial</div>
                    <div class="gray">Discount</div>
                    <div class="gray">Final</div>
                </div>
                <fieldset class="repeating_meritpurchases">
                    <div><input type="text" name="attr_merit_purchase_info"/></div>
                    <div><input type="number" name="attr_merit_initial" value="0" min="0"/></div>
                    <div><input type="number" name="attr_merit_discount" value="0" min="0"/></div>
                    <div>
                        <input type="hidden" name="attr_merit_total" value="0"/>
                        <span name="attr_merit_total"></span>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
</div>
<div class="inventory repeating-row-table grid-like-padding">
    <div class="header">
        <!--Row 1-->
        <div class="crimson repeating-rowspan-2 large">Carried Items</div>
        <div class="light-crimson">Current Bulk</div>
        <div class="light-crimson">Max Bulk</div>
        <div class="light-crimson">Encumbered</div>
        <div class="light-crimson">Overencumbered</div>
        <!--Row 2-->
        <div>
            <input name="attr_item_total_bulk" type="hidden" min="0" value="1"/>
            <span name="attr_item_total_bulk"></span>
        </div>
        <div>
            <input name="attr_item_total_bulk_max" type="number" min="0" value="1" step="0.1"/>
        </div>
        <div><input name="attr_item_encumbered" type="checkbox" value="1"/></div>
        <div><input name="attr_item_overencumbered" type="checkbox" value="1"/></div>
        <!--Row 3-->
        <div class="gray">Item Name</div>
        <div class="gray">Bulk</div>
        <div class="gray">Quantity</div>
        <div class="gray repeating-colspan-2">Total</div>
    </div>
    <fieldset class="repeating_inventory">
        <div><input type="text" name="attr_item_name"/></div>
        <div><input type="number" name="attr_item_bulk" value="0" min="0" step="0.1"/></div>
        <div><input type="number" name="attr_item_quantity" value="1" min="1"/></div>
        <div class="repeating-colspan-2">
            <input type="hidden" name="attr_item_totalbulk" value="1"/>
            <span name="attr_item_totalbulk"></span>
        </div>
    </fieldset>
</div>

<rolltemplate class="sheet-rolltemplate-pool_roll">
    <div class="sheet-template-container">
        <table>
            <tr><th class="crimson large" colspan="2">{{name}}</th></tr>
            <tr>
                <th class="gray">Dice Pool</th>
                <td>{{pool}}</td>
            </tr>
            <tr>
                <th class="gray">Dot Dice Roll</th>
                <td>{{computed::roll}}</td>
            </tr>
        </table>
    </div>
</rolltemplate>

<script type="text/worker">
    /* ===== PARAMETERS ==========
    destinations = the name of the attribute that stores the total quantity
            can be a single attribute, or an array: ['total_cost', 'total_weight']
            If more than one, the matching fields must be in the same order. 
        section = name of repeating fieldset, without the repeating_
        fields = the name of the attribute field to be summed
            destination and fields both can be a single attribute: 'weight'
            or an array of attributes: ['weight','number','equipped']
    */
    const repeatingSum = (destinations, section, fields) => {
        if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
        if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
        getSectionIDs(`repeating_${section}`, idArray => {
            const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
            getAttrs([...attrArray], v => {
                const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
                const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
                const output = {};
                destinations.forEach((destination, index) => {
                    output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
                });
                setAttrs(output);
            }); 
        }); 
    };

    const attributes = ["body", "mind", "soul"];
    const expertises = ["charming", "cunning", "empathetic", "forceful", "innovative", "instinct", "logic", "teamwork"];
    const skills = [
        "athletics", "brawl", "initiative", "insight", "integrity", "perception", "persuasion", "presence", "send",
        "acrobatics", "clash", "deception", "evasion", "marksman", "navigation", "perform", "subterfuge", "survival",
        "academics", "appraisal", "craft", "etiquette", "investigation", "lore", "medicine", "science", "technology"
    ];

    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.substring(1);
    }

    function query(name, options) {
        let values = options
            .map(o => `${capitalize(o)}, @{${o}}[Base ${capitalize(o)}] + @{${o}_bonus}[Bonus ${capitalize(o)}]`)
            .join("|")
        values = values + "|None, 0"; 
        return "?{" + name + "|" + values + "}";
    }

    function max(options) {
        let values = options
            .map(o => "@{" + o + "}+@{" + o + "_bonus}[" + capitalize(o) + "]")
            .join(",")
            
        return "[[{" + values + "}kh1]][Highest Expertise]"
    }

    function max_stat(options, results) {
        var totals = options
            .map(stat => parseInt(results[stat]) + parseInt(results[stat + "_bonus"]));
        return Math.max(...totals);
    }

    function dot_roll(expression, name, difficultyMod, promptExplode) {
        difficultyPart = difficultyMod ? `[[?{Difficulty?|7} ${difficultyMod}]]` : "?{Difficulty?|7}"
        explodePart = promptExplode ? "!>?{Explode At?|10}" : "!" ;
        roll = `[[[[${expression}]]d10>${difficultyPart}f1${explodePart}]]`;
        startRoll("&{template:pool_roll} {{name=" + name + "}} {{pool=[[" + expression + "]]}} {{roll=" + roll + "}}", (results) => {
            const total = results.results.roll.result
            const numberOfTens = results.results.roll.dice.filter(i => i >= 10).length;

            finishRoll(
                results.rollId,
                {
                    roll: total + numberOfTens
                }
            );
        });
    }

    on('clicked:skill_check', (info) => {
        pool = `${query("Attribute", attributes)} + ${query("Expertise", expertises)} + ${query("Skill", skills)} + ?{Pool Bonus|0}`;
        dot_roll(pool, "Skill Check");
    });

    on('clicked:dot_roll', (info) => {
        dot_roll("?{Num Dice?|1}", "Dot Roll", null, true);
    });

    on('clicked:accuracy_move_roll', (info) => {
        physSpecRoll = "?{Phys Or Spec?|Physical,@{body}[Base Body]+@{body_bonus}[Body Bonus]|Special,@{mind}[Base Mind]+@{mind_bonus}[Mind Bonus]}";
        rangeRoll = "?{Range?|Melee Move,@{brawl}[Base Brawl]+@{brawl_bonus}[Bonus Brawl]|Ranged Move,@{send}[Base Send]+@{send_bonus}[Send Bonus]|Melee Weapon,@{clash}[Base Clash]+@{clash_bonus}[Clash Bonus]|Ranged Weapon,@{marksman}[Base Marksman]+@{marksman_bonus}[Marksman Bonus]}";
        let pool = `${physSpecRoll} + ${max(expertises)} + ${rangeRoll} + @{accuracy_stage}[Accuracy Stages] +  @{passive_accuracy_stage}[Passive Accuracy Stages] + ?{Move Accuracy|0}[Move Accuracy]`;
        
        dot_roll(pool, "Move Accuracy Roll");
    });

    const moveAccuracyAttributes = ['repeating_attacklist_attack_name', 'repeating_attacklist_attack_type', 'repeating_attacklist_attack_skill', 'repeating_attacklist_attack_accuracy'];
    on('clicked:repeating_attacklist:specificaccuracymoveroll', (info) => {
        getAttrs(moveAccuracyAttributes, (move) => {
            query = [];
            if (move.repeating_attacklist_attack_type == "physical") {
                query.push("@{body}[Base Body]", "@{body_bonus}[Body Bonus]");
            } else if (move.repeating_attacklist_attack_type == "special") {
                query.push("@{mind}[Base Mind]", "@{mind_bonus}[Mind Bonus]");
            }

            query.push(`${max(expertises)}`);
            
            let lowercaseSkill = move.repeating_attacklist_attack_skill.toLowerCase();
            let formattedSkill = capitalize(move.repeating_attacklist_attack_skill);
            query.push(`@{${lowercaseSkill}}[Base ${formattedSkill}]`, `@{${lowercaseSkill}_bonus}[Bonus ${formattedSkill}]`);

            query.push(`${move.repeating_attacklist_attack_accuracy}[Move Accuracy]`);
            query.push("@{accuracy_stage}[Accuracy Stages]", "@{passive_accuracy_stage}[Passive Accuracy Stages]");

            dot_roll(query.join(" + "), move.repeating_attacklist_attack_name + " Accuracy Roll");
        });
    });

    on('clicked:power_roll', (info) => {
        physSpecRoll = "?{Phys Or Spec?|Physical,@{body}[Base Body]+@{body_bonus}[Body Bonus]|Special,@{mind}[Base Mind]+@{mind_bonus}[Mind Bonus]}";
        rangeRoll = "?{Range?|Melee Move,@{brawl}[Base Brawl]+@{brawl_bonus}[Bonus Brawl]|Ranged Move,@{send}[Base Send]+@{send_bonus}[Send Bonus]|Melee Weapon,@{clash}[Base Clash]+@{clash_bonus}[Clash Bonus]|Ranged Weapon,@{marksman}[Base Marksman]+@{marksman_bonus}[Marksman Bonus]}";
        basePowerRoll = "?{Base Power?|1}[Base Power]"
        let expression = `round((${physSpecRoll} + ${rangeRoll} + ${basePowerRoll}) * ?{Crit?|Yes,1.5|No,1})`;
        let expressionWithCrit = expression;

        let typeAdvantage = "[[?{Difficulty?|7} + ?{Type Effectiveness?|Neutral,0|Super Effective,-1|Double Effective,-2|Resistant, 1|Double Resistant, 2}]]"
        
        roll = `[[[[${expressionWithCrit}]]d10>${typeAdvantage}f1!]]`;
        startRoll("&{template:pool_roll} {{name=Power Roll}} {{pool=[[" + expressionWithCrit + "]]}} {{roll=" + roll + "}}", (results) => {
            const total = results.results.roll.result
            const numberOfTens = results.results.roll.dice.filter(i => i >= 10).length;

            finishRoll(
                results.rollId,
                {
                    roll: total + numberOfTens
                }
            );
        });
    });

    const movePowerAttributes = ['repeating_attacklist_attack_name', 'repeating_attacklist_attack_type', 'repeating_attacklist_attack_skill', 'repeating_attacklist_attack_power'];
    on('clicked:repeating_attacklist:specificpowermoveroll', (info) => {
        getAttrs(movePowerAttributes, (move) => {
            query = [];
            if (move.repeating_attacklist_attack_type == "physical") {
                query.push("@{body}[Base Body]", "@{body_bonus}[Body Bonus]");
            } else if (move.repeating_attacklist_attack_type == "special") {
                query.push("@{mind}[Base Mind]", "@{mind_bonus}[Mind Bonus]");
            }
            
            let lowercaseSkill = move.repeating_attacklist_attack_skill.toLowerCase();
            let formattedSkill = capitalize(move.repeating_attacklist_attack_skill);
            query.push(`@{${lowercaseSkill}}[Base ${formattedSkill}]`, `@{${lowercaseSkill}_bonus}[Bonus ${formattedSkill}]`);
            query.push(`${move.repeating_attacklist_attack_power}[Move Power]`);
            query = query.join(" + ");

            let expressionWithCrit = `?{Crit?|No,${query}|Yes,round((${query}) * 1.5)}`;
            let typeAdvantage = "[[?{Difficulty?|7} + ?{Type Effectiveness?|Neutral,0|Super Effective,-1|Double Effective,-2|Resistant, 1|Double Resistant, 2}]]";

            roll = `[[[[${expressionWithCrit}]]d10>${typeAdvantage}f1!]]`;
            startRoll("&{template:pool_roll} {{name=" + move.repeating_attacklist_attack_name + " Power Roll}} {{pool=[[" + expressionWithCrit + "]]}} {{roll=" + roll + "}}", (results) => {
                const total = results.results.roll.result
                const numberOfTens = results.results.roll.dice.filter(i => i >= 10).length;

                finishRoll(
                    results.rollId,
                    {
                        roll: total + numberOfTens
                    }
                );
            });
        });
    });

    on('clicked:accuracy_effect_roll', (info) => {
        let pool = `@{soul}[Base Soul] + @{soul_bonus}[Soul Bonus] + ${max(expertises)} + ${query("Skill", ["deception", "etiquette", "persuasion", "presence"])}`;
        
        dot_roll(pool, "Effect Accuracy Roll");
    });

    on('clicked:reset_stat_changes', (info) => {
        setAttrs({
            "phys_damage_stage": 0,
            "crit_chance_stage": 0,
            "spec_damage_stage": 0,
            "accuracy_stage": 0,
            "phys_integrity_stage": 0,
            "evasion_stage": 0,
            "spec_integrity_stage": 0,
            "initiative_stage": 0,
            "soul_save_stage": 0,
            "speed_stage": 0
        })
    });

    // Max HP calculation
    const maxHpStats = ['body', 'body_bonus', 'mind', 'mind_bonus', 'soul', 'soul_bonus', 'vigor', 'vigor_bonus', 'willpower', 'willpower_bonus', 'extra_max_hp'];
    on(maxHpStats.map(stat => `change:${stat}`).join(' '), () => {
        getAttrs(maxHpStats, values => {
            let total = Object.values(values)
                .map(a => parseInt(a))
                .reduce((a, b) => a + b, 0);
            setAttrs({
                "hp_max": total
            })
        });
    });

    // Evasion and Integrity calculations
    const evasionIntegrityStats = ['body', 'mind', 'soul', ...expertises, 'evasion', 'integrity'].flatMap(stat => [stat, `${stat}_bonus`]);
    const integrityStageStats = ['phys_integrity_stage', 'spec_integrity_stage', 'passive_phys_integrity_stage', 'passive_spec_integrity_stage'];
    const allRelatedStats = [...evasionIntegrityStats, ...integrityStageStats, 'evasion_stage', 'passive_evasion_stage', 'soul_save_stage', 'passive_soul_save_stage'];
    
    on(allRelatedStats.map(stat => `change:${stat}`).join(' '), () => {
        getAttrs(allRelatedStats, values => {
            var body = parseInt(values.body); var bodyBonus = parseInt(values['body_bonus']);
            var mind = parseInt(values.mind); var mindBonus = parseInt(values['mind_bonus']);
            var soul = parseInt(values.soul); var soulBonus = parseInt(values['soul_bonus']);
            var expertise = max_stat(expertises, values);
            var evasion = parseInt(values.evasion);
            var integrity = parseInt(values.integrity);

            var physIntegrityBuffs = parseInt(values['phys_integrity_stage']) + parseInt(values['passive_phys_integrity_stage']);
            var specIntegrityBuffs = parseInt(values['spec_integrity_stage']) + parseInt(values['passive_spec_integrity_stage']);
            var evasionBuffs = parseInt(values['evasion_stage']) + parseInt(values['passive_evasion_stage']);
            var soulSaveBuffs = parseInt(values['soul_save_stage']) + parseInt(values['passive_soul_save_stage']);

            var expCap = Math.floor((body + bodyBonus + mind + mindBonus + soul + soulBonus) / 5) * 30;
            var powerCap = 4 + (Math.floor((body + bodyBonus + mind + mindBonus + soul + soulBonus) / 5) * 2)

            setAttrs({
                "physical_evasion": Math.round((body + expertise + evasion) / 2) + evasionBuffs,
                "physical_integrity": Math.round((body + expertise + integrity) / 2) + physIntegrityBuffs,
                "special_evasion": Math.round((mind + expertise + evasion) / 2) + evasionBuffs,
                "special_integrity": Math.round((mind + expertise + integrity) / 2) + specIntegrityBuffs,
                "soul_save": Math.round((soul + expertise + integrity) / 2) + soulSaveBuffs,

                "cap_qa_exp": Math.floor(expCap / 2),
                "cap_sa_exp": expCap,
                "cap_fa_exp": expCap * 2,
                "cap_qa_power": Math.floor(powerCap / 2),
                "cap_sa_power": powerCap,
                "cap_fa_power": powerCap * 2
            })
        });
    });

    // Boost Per Session calculation
    on(attributes.map(stat => `change:${stat}`).join(' '), () => {
        getAttrs(attributes, values => {
            let total = Object.values(values)
                .map(a => parseInt(a))
                .reduce((a, b) => a + b, 0);
            setAttrs({
                "boost_per_session": Math.round(total / 3)
            })
        });
    });

    // Per-Item Total Bulk Calculation
    on('change:repeating_inventory:item_bulk change:repeating_inventory:item_quantity', function() {
        getAttrs(['repeating_inventory_item_bulk', 'repeating_inventory_item_quantity'], idArray => {
            let itemTotalBulk = parseFloat(idArray.repeating_inventory_item_bulk) * parseInt(idArray.repeating_inventory_item_quantity);
            setAttrs({
                repeating_inventory_item_totalbulk: itemTotalBulk
            })
        });
    });

    // Total Bulk Calculation
    on('change:repeating_inventory remove:repeating_inventory', function() {
        repeatingSum("item_total_bulk","inventory",["item_bulk","item_quantity"]);
    });

    // Encumberance/Overencumberance
    on('change:item_total_bulk change:item_total_bulk_max', function() {
        getAttrs(['item_total_bulk', 'item_total_bulk_max'], attrs => {
            let cBulk = parseFloat(attrs.item_total_bulk)
            let mBulk = parseFloat(attrs.item_total_bulk_max)
            setAttrs({
                item_encumbered: cBulk > mBulk ? "1" : "0",
                item_overencumbered: cBulk > (mBulk * 2) ? "1" : "0"
            })
        })
    });

    const expMerits = ['exp', 'merit']
    expMerits.forEach(stat => {
        // Per-Item Total Calculation
        on(`change:repeating_${stat}purchases:${stat}_initial change:repeating_${stat}purchases:${stat}_discount`, function(){
            let prefix = `repeating_${stat}purchases`;
            let initialStatName = `${prefix}_${stat}_initial`
            let discountStatName = `${prefix}_${stat}_discount`
            let totalStatName = `${prefix}_${stat}_total`
            getAttrs([initialStatName, discountStatName], function(resolved) {
                let total = parseInt(resolved[initialStatName]) - parseInt(resolved[discountStatName]);
                let returnBlock = {};
                returnBlock[totalStatName] = total;
                setAttrs(returnBlock);
            })
        })

        //Spent and Discount
        on(`change:repeating_${stat}purchases remove:repeating_${stat}purchases`, function() {
            repeatingSum(`${stat}_total_spent`,`${stat}purchases`,`${stat}_total`);
            repeatingSum(`${stat}_total_discount`,`${stat}purchases`,`${stat}_discount`);
        });

        //Grand Effective Total
        on(`change:${stat}_total_spent change:${stat}_total_discount`, function() {
            let initialStatName = `${stat}_total_spent`
            let discountStatName = `${stat}_total_discount`
            let totalStatName = `${stat}_grand_total`
            getAttrs([initialStatName, discountStatName], function(resolved) {
                let total = parseInt(resolved[initialStatName]) + parseInt(resolved[discountStatName]);
                let returnBlock = {};
                returnBlock[totalStatName] = total;
                setAttrs(returnBlock);
            })
        });
    });

    const buttonlist = ["basic", "combat", "attacks", "feats", "exp", "inventory"];
    buttonlist.forEach(button => {
        on(`clicked:tab_${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });

    function resolveTemplate(t, rowId, repeating, prefix) {
        return Object.entries(t)
            .reduce((acc, cur) => {acc[`repeating_${repeating}_${rowId}_${prefix}_${cur[0]}`] = cur[1]; return acc;}, {})
    }

    const characterCreateOptions = {
        exp: 100,
        move: {
            name: "Legally Distinct Normal Attack",
            type: "physical",
            skill: "Brawl",
            element: "Normal",
            accuracy: 0,
            power: 4,
            range: "Melee",
            exp: 20,
            exp_max: 30
        },
        feats: {
            types: 2,
            typeTemplate: [{
                name: "<type> Type Affinity",
                description: "Able to purchase moves of this type for normal EXP"
            }, {
                name: "<type> STAB Affinity",
                description: "Moves of this type gain STAB on Damage Roll"
            }]
        }
    };
    on('clicked:character_init', function() {
        let attrs = {
            exp_total_earned: characterCreateOptions.exp
        };
        setAttrs(attrs);

        let rowId = generateRowID();
        setAttrs(resolveTemplate(characterCreateOptions.move, rowId, "attacklist", "attack"));

        let rowIdPool = [];
        while(rowIdPool.length < (characterCreateOptions.feats.types * characterCreateOptions.feats.typeTemplate.length)) {
            let test = generateRowID();
            if (!rowIdPool.includes(test)) {
                rowIdPool.push(test);
            }
        }

        for(let t = 0; t < characterCreateOptions.feats.types; t++) {
            for(let template of characterCreateOptions.feats.typeTemplate) {
                rowId = rowIdPool.pop();
                setAttrs(resolveTemplate(template, rowId, "feats", "feat"));
            }
        }
    });
</script>